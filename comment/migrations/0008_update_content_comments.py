# Generated by Django 3.1.2 on 2021-02-08 20:35
import logging
import re

from django.db import migrations

from comment.helpers import get_comment_by_id, get_reply_by_id
from user.utils.name import get_capitalized_name

logger = logging.getLogger('comments')


def update_content(content='', old_mention=''):
    pattern = re.compile(
        r"\[@"
        + old_mention  # Begin with [@
        + r"\]"  # Name of the old mention  # Ends with ]
    )

    return pattern.sub("", content)


def update_comments_replies_content(apps, schema_editor):
    mention = apps.get_model('comment', 'mention')
    user = apps.get_model('user', 'User')
    mentions = mention.objects.all()
    user_id = ''
    comment_id = ''
    try:
        for m in mentions:
            comment_id = m.comment_id
            user_id = m.user_id
            user_match = user.objects.get(id=m.user_id)
            old_mention = get_capitalized_name(
                user_match.first_name, user_match.last_name
            )

            mention_comment = get_comment_by_id(m.comment_id)
            mention_reply = get_reply_by_id(m.reply_id)

            if mention_comment:
                mention_comment.content = update_content(
                    mention_comment.content, old_mention
                )
                mention_comment.save()

            if mention_reply:
                mention_reply.content = update_content(
                    mention_reply.content, old_mention
                )
                mention_reply.save()

    except Exception as e:
        logger.exception(
            f'Failed finding user: {user_id} '
            f'for comment with id {comment_id} here is the error: {e}'
        )


class Migration(migrations.Migration):
    dependencies = [
        ('organization', '0011_setting_permissions_to_roles'),
        ('comment', '0007_adding_replyalert_model'),
    ]

    operations = [migrations.RunPython(update_comments_replies_content)]

# Generated by Django 3.0.7 on 2020-10-06 13:59

from django.db import migrations

FIND_QUESTIONS = '''
CREATE OR REPLACE FUNCTION find_questions(questions TEXT[], threshold DECIMAL)
    RETURNS TABLE
            (
                input            TEXT,
                question_id      INTEGER,
                library_entry_id INTEGER,
                question_index   INTEGER
            )
as
$$
DECLARE
    question_id      INTEGER;
    input            TEXT;
    question_index   INTEGER;
    library_entry_id INTEGER;
BEGIN
    question_index := 0;
    FOREACH input IN ARRAY questions
        LOOP
            BEGIN
                question_index := question_index + 1;
                SELECT lq.id, lq.library_entry_id
                INTO STRICT question_id, library_entry_id
                FROM library_question lq
                WHERE to_tsvector('english', lq.text) @@
                      phraseto_tsquery(input)
                ORDER BY similarity(lq.text, input) DESC
                LIMIT 1;
                RETURN QUERY SELECT input,
                                    question_id,
                                    library_entry_id,
                                    question_index;
            EXCEPTION
                WHEN NO_DATA_FOUND THEN
                    SELECT lq.id,
                           lq.library_entry_id
                    INTO question_id, library_entry_id
                    FROM library_question lq
                    WHERE lq.text % input
                      AND similarity(lq.text, input) >= threshold
                    ORDER BY similarity(lq.text, input) DESC;
                    RETURN QUERY SELECT input,
                                        question_id,
                                        library_entry_id,
                                        question_index;
            END;

        END LOOP;
    RETURN;

END;
$$ LANGUAGE plpgsql;
'''


class Migration(migrations.Migration):
    dependencies = [
        ('library', '0007_question_search'),
    ]

    operations = [
        migrations.RunSQL(FIND_QUESTIONS),
    ]

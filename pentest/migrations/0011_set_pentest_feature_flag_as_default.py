from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [('pentest', '0010_remove_third_party_id')]

    operations = [
        migrations.RunSQL(
            '''
            BEGIN;
            UPDATE feature_flag 
            SET is_enabled = true 
            WHERE name = 'pentestFeatureFlag' 
            AND is_enabled = false;
            INSERT INTO feature_flag(
                created_at,
                updated_at,
                name,
                is_enabled,
                organization_id
            )
            SELECT 
                now() AS created_at,
                now() AS updated_at,
                'pentestFeatureFlag' AS name,
                true AS is_enabled,
                o.id AS organization_id
            FROM (
                SELECT o.id 
                FROM organization_organization AS o 
                WHERE id NOT IN (
                    SELECT o.id
                    FROM organization_organization AS o
                    LEFT JOIN feature_flag AS ff ON ff.organization_id = o.id
                    WHERE ff.name = 'pentestFeatureFlag'
                )
            ) AS o;
            COMMIT;
            ''',
            reverse_sql='',
        )
    ]

{% extends "partner/base_portal.html" %}
{% block content %}
    <script type="text/javascript">
        function upload(submit) {
            submit.form.reportValidity()
            if (!submit.form.checkValidity()) {
                return
            }
            const mb = 1024 * 1024
            const file = submit.form.attachment.files[0]
            if (file.size > (10 * mb)) {
                alert("The file size must be no more than 10 MB")
                return
            }
            submit.disabled = true
            submit.form.submit()
        }
    </script>

    <div class="container-fluid" style="max-width: 800px;">

        <h3>Pentest Detail</h3>

        <div class="mb-3">
            <label class="form-label">Name:</label> {{ pentest.name }}
        </div>
        <div class="mb-3">
            <label class="form-label">Organization:</label> {{ pentest.organization.name }}
        </div>
        <div class="mb-3">
            <label class="form-label">Status:</label> {{ pentest.status }}
        </div>
        <p/>
        <table class="table" data-test-id="attachment_table">
            <caption>Attachments for {{ pentest.name }}</caption>
            <tr>
                <th scope="col">Created At</th>
                <th scope="col">Name</th>
                <th scope="col">Critical</th>
                <th scope="col">High</th>
            </tr>
            {% for attachment in attachments %}
                <tr>
                    <td>{{ attachment.created_at }}</td>
                    <td>{{ attachment.name }}</td>
                    <td>{{ attachment.critical_vulnerabilities }}</td>
                    <td>{{ attachment.high_vulnerabilities }}</td>
                </tr>
            {% endfor %}
            {% if not attachments %}
                <tr>
                    <td colspan="4">No attachments are available.</td>
                </tr>
            {% endif %}
        </table>


        {% if action == 'start' %}
            <form action="/pentest/{{ pentest.id }}/start/" method="post">
                {% csrf_token %}
                <input type="button" value="Pentest is in progress" class="btn btn-primary" onclick="this.disabled = true; this.form.submit()">
            </form>
        {% endif %}
        {% if action == 'attach' %}

            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                Add Attachment
            </button>

        {% endif %}
    </div>


    <!-- Modal -->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
         aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="test123" action="/pentest/{{ pentest.id }}/upload/" method="post" enctype="multipart/form-data">
                    <div class="modal-header">
                        <h5 class="modal-title" id="staticBackdropLabel">New Attachment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">

                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="result" class="form-label">Report Result:</label>

                            <select id="result" name="status" class="form-control">
                                <option value="in_progress">Retest Required</option>
                                <option value="ready">Successful Pentest</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="attachment" class="form-label">Upload Attachment:</label>
                            <input type="file" name="attachment" required/>
                        </div>
                        <div class="mb-3">
                            <label for="executive_summary" class="form-label">Executive Summary:</label>
                            <textarea class="form-control" id="executive_summary" rows="3" name="executive_summary"
                                      required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="vulnerabilities" class="form-label">Vulnerabilities:</label>
                            <div id="vulnerabilities">
                                Critical: <input name="critical" type="number" min="0" max="1000" step="1" value="0" required/>
                                High: <input name="high" type="number" min="0" max="1000" step="1" value="0" required/>
                                Medium: <input name="medium" type="number" min="0" max="1000" step="1" value="0" required/>
                                Low: <input name="low" type="number" min="0" max="1000" step="1" value="0" required/>
                                Info: <input name="info" type="number" min="0" max="1000" step="1" value="0" required/>
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary"  onclick="upload(this)">Save</button>
                    </div>

                </form>
            </div>

        </div>
    </div>
{% endblock %}

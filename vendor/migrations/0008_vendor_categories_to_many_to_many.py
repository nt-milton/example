# Generated by Django 3.0.3 on 2020-03-22 16:32
import json
import logging
import os

from django.db import migrations

__location__ = os.path.realpath(os.path.join(os.getcwd(), os.path.dirname(__file__)))

logger = logging.getLogger('vendor')


def create_vendor_categories(apps, vendor, categories_to_import):
    Category = apps.get_model('vendor', 'Category')
    VendorCategory = apps.get_model('vendor', 'VendorCategory')

    for category_to_import in categories_to_import:
        category, _ = Category.objects.get_or_create(name=category_to_import['name'])
        VendorCategory.objects.get_or_create(vendor=vendor, category=category)


def create_vendors(apps):
    Vendor = apps.get_model('vendor', 'Vendor')

    files_to_import = [
        'advertising.json',
        'analytics.json',
        'big_data.json',
        'cloud_computing.json',
        'crm.json',
        'e_comerce.json',
        'enterprise_software.json',
        'information_technology.json',
        'internet.json',
        'marketing.json',
        'marketing_automation.json',
        'mobile.json',
        'saas.json',
        'software.json',
    ]
    for file_to_import in files_to_import:
        file = open(os.path.join(__location__, f'default_vendors/{file_to_import}'))
        category = json.load(file)
        for vendor_to_import in category['vendors']:
            vendor = Vendor.objects.get(
                name=vendor_to_import['name'], website=vendor_to_import['website']
            )
            create_vendor_categories(apps, vendor, vendor_to_import['categories'])


def migrate(apps, schema_editor):
    create_vendors(apps)


class Migration(migrations.Migration):
    dependencies = [
        ('vendor', '0007_increase_financial_exposure_precision'),
    ]

    operations = [migrations.RunPython(migrate)]
